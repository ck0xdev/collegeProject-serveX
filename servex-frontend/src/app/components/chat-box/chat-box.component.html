<!-- src/app/components/chat-box/chat-box.component.html -->

<!-- Chat Toggle Button (Floating) -->
<button 
  class="chat-toggle-btn"
  (click)="toggleChat()"
  [class.open]="isOpen"
>
  @if (!isOpen) {
    <span class="chat-icon">ðŸ’¬</span>
    @if (unreadCount > 0) {
      <span class="unread-badge">{{ unreadCount }}</span>
    }
  } @else {
    <span class="close-icon">âœ•</span>
  }
</button>

<!-- Chat Window -->
@if (isOpen) {
  <div class="chat-window">
    <!-- Chat Header -->
    <div class="chat-header">
      <div class="chat-header-info">
        <h3>{{ projectName }}</h3>
        <p>Chat with {{ currentUser?.role === 'admin' ? 'Client' : 'Admin' }}</p>
      </div>
      <button class="minimize-btn" (click)="toggleChat()">â”€</button>
    </div>

    <!-- Messages Container -->
    <div class="messages-container" #messagesContainer>
      @if (loading) {
        <div class="loading-messages">
          <div class="spinner-small"></div>
          <p>Loading messages...</p>
        </div>
      } @else if (messages.length === 0) {
        <div class="empty-chat">
          <div class="empty-icon">ðŸ’­</div>
          <p>No messages yet</p>
          <small>Start the conversation!</small>
        </div>
      } @else {
        @for (message of messages; track message.id; let i = $index) {
          <!-- Date Separator -->
          @if (shouldShowDate(i)) {
            <div class="date-separator">
              <span>{{ formatDate(message.timestamp) }}</span>
            </div>
          }

          <!-- Message Bubble -->
          <div 
            class="message-wrapper"
            [class.my-message]="isMyMessage(message)"
            [class.their-message]="!isMyMessage(message)"
          >
            <div class="message-bubble">
              @if (!isMyMessage(message)) {
                <div class="sender-name">{{ message.senderName }}</div>
              }
              <div class="message-text">{{ message.message }}</div>
              <div class="message-time">{{ formatTime(message.timestamp) }}</div>
            </div>
          </div>
        }
      }

      <!-- Typing Indicator -->
      @if (isTyping) {
        <div class="typing-indicator">
          <div class="typing-bubble">
            <span class="typing-name">{{ typingUser }}</span>
            <div class="typing-dots">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>
        </div>
      }
    </div>

    <!-- Input Area -->
    <div class="chat-input-area">
      <input
        type="text"
        [(ngModel)]="newMessage"
        (input)="onTyping()"
        (keyup.enter)="sendMessage()"
        placeholder="Type a message..."
        class="chat-input"
      />
      <button 
        class="send-btn"
        (click)="sendMessage()"
        [disabled]="!newMessage.trim()"
      >
        <span class="send-icon">ðŸ“¤</span>
      </button>
    </div>
  </div>
}